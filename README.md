# STM32_Motor-Control

STM32CubeIDEでモーター制御を行う方法を公開します。使用するボードはSTM32L476RGで、モーターはマイクロサーボSG90とSX-101zを使用しました。

## STM32L476RG ピン配置図

### チップ詳細
![STM32L476RG ピンアウト](images/stm32l476rg_pinout.png)

**パッケージ**: LQFP64  
**マイコン**: STM32L476RGTx  
**コア**: ARM Cortex-M4 80MHz  

### 本プロジェクトで使用するピン

#### PWM出力ピン（サーボ制御用）
| ピン番号 | ピン名 | 機能 | 用途 |
|---------|--------|------|------|
| 24 | PA6 | TIM3_CH1 | サーボ1制御 |
| 25 | PA7 | TIM3_CH2 | サーボ2制御 |
| 43 | PA8 | TIM1_CH1 | 予備PWM |

#### 電源ピン
| ピン番号 | ピン名 | 機能 | 用途 |
|---------|--------|------|------|
| 50 | VDD | 3.3V電源 | メイン電源 |
| 49 | VSS | グランド | 接地 |
| 21 | VDD | 3.3V電源 | 追加電源 |
| 20 | VSS | グランド | 追加接地 |

#### その他の重要ピン
| ピン番号 | ピン名 | 機能 | 用途 |
|---------|--------|------|------|
| 7 | NRST | リセット | システムリセット |
| 62 | BOOT0 | ブート選択 | プログラムモード |

## タイマー設定詳細

### TIM3設定（PWM生成用）
- **ベースクロック**: 80MHz (システムクロック)
- **プリスケーラー**: 1599 (80MHz ÷ 1600 = 50kHz)
- **オートリロード**: 999 (50kHz ÷ 1000 = 50Hz)
- **結果**: 50Hz PWM信号生成

### PWMデューティ比計算

```c
// サーボ角度制御用の計算式
// 0°   : デューティ比 = 50  (1ms / 20ms = 5%)
// 90°  : デューティ比 = 75  (1.5ms / 20ms = 7.5%)
// 180° : デューティ比 = 100 (2ms / 20ms = 10%)

uint16_t angle_to_duty(uint8_t angle) {
   return 50 + (angle * 50) / 180;
}

# STM32CubeMX設定ガイド

## 1. ピン設定
- **PA6** → `TIM3_CH1`  
- **PA7** → `TIM3_CH2`  
- **モード**: `PWM Generation CH1`, `PWM Generation CH2`  

---

## 2. タイマー設定
**Timer3 Configuration**:
├── Clock Source: Internal Clock
├── Prescaler: 1599
├── Counter Period: 999
├── Counter Mode: Up
└── Pulse: 75 (初期値: 90度)


---

## 3. クロック設定
- **System Clock**: `80MHz`  
- **APB1 Timer Clock**: `80MHz`  
- **PWM周波数**: `50Hz` 確定  

---

## 4. GPIO設定確認
- **PA6, PA7**: `Alternate Function Push Pull`  
- **Pull-up/Pull-down**: `No pull-up and no pull-down`  
- **Maximum output speed**: `High`  

---

## 配線図
📷 `画像を表示`  

---

## 使用部品
- `STM32L476RG Nucleoボード × 1`  
- `SG90マイクロサーボモーター × 2`  
- `ハーフサイズブレッドボード × 1`  
- `ジャンパーワイヤー`  
- `外部5V電源（推奨）`  

---

## 配線接続
### サーボモーター1
- **赤線（電源）**: `ブレッドボード電源レール (+5V)`  
- **茶線（GND）**: `ブレッドボード接地レール (GND)`  
- **橙線（信号）**: `STM32 PA6ピン (TIM3_CH1)`  

### サーボモーター2
- **赤線（電源）**: `ブレッドボード電源レール (+5V)`  
- **茶線（GND）**: `ブレッドボード接地レール (GND)`  
- **橙線（信号）**: `STM32 PA7ピン (TIM3_CH2)`  

### 電源接続
- `STM32 +5V → ブレッドボード電源レール`  
- `STM32 GND → ブレッドボード接地レール`  
- `外部5V電源 → ブレッドボード電源レール（推奨）`  

---

## ⚠️ 重要な注意事項
- **電源容量**: 複数サーボを使用する場合は外部5V電源を推奨  
- **共通GND**: STM32とサーボのGNDは必ず共通接続  
- **PWM周波数**: `50Hz（20ms周期）` で動作  
- **信号電圧**: STM32の3.3V出力でSG90は正常動作  

---

## PWM制御パラメータ
- **周波数**: `50Hz (20ms周期)`  
- **パルス幅**: `1–2ms (1ms=0°, 1.5ms=90°, 2ms=180°)`  
- **使用タイマー**: `TIM3 (STM32L476RG)`  

---

## サーボ制御実装例

### 初期化コード
```c
// TIM3 PWM開始
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_1);  // PA6
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_2);  // PA7

// 初期角度設定（90度）
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 75);
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, 75);

# 角度制御関数
void servo_set_angle(uint32_t channel, uint8_t angle) {
    if (angle > 180) angle = 180;
    
    uint16_t duty = 50 + (angle * 50) / 180;
    __HAL_TIM_SET_COMPARE(&htim3, channel, duty);
}

// 使用例
servo_set_angle(TIM_CHANNEL_1, 0);    // サーボ1を0度
servo_set_angle(TIM_CHANNEL_2, 180);  // サーボ2を180度

## 対応プログラム
- この配線図は `Core/Src/main.c` のサーボ制御プログラムに対応  
- PWM出力の設定は `STM32CubeMX の .ioc ファイル` で確認可能  

---

## 動作確認
📷 `実際の動作写真`  

### 確認できる動作
- サーボホーン（白いアーム）の回転動作  
- 2つのサーボモーターの同期制御  
- LEDインジケータによる動作状態表示  

### 動作パターン
- **初期化**: 両サーボが中央位置（90°）に移動  
- **テストパターン**: `0° → 90° → 180° → 90°` の順次動作  
- **同期動作**: 2つのサーボが同時に回転  
- **個別制御**: 各サーボを独立して制御  

---

## 動作仕様確認
### PWM信号
- **周波数**: `50Hz（20ms周期）`  
- **デューティ比**: `5–10%（1–2msパルス幅）`  
- **電圧レベル**: `3.3V TTLで正常動作`  

### レスポンス性能
- **応答速度**: `0.1秒/60°`  
- **精度**: `±1°程度`  
- **トルク**: 軽負荷で安定動作確認  

---

## 学習ポイント
### ハードウェア制御
- STM32のタイマー機能活用  
- PWM信号生成とデューティ比制御  
- 複数デバイスの電源管理  

### ソフトウェア開発
- HALライブラリを使用したPWM制御  
- リアルタイム制御プログラミング  
- STM32CubeMXによる効率的開発  

### システム設計
- 信号配線とノイズ対策  
- 電源容量計算と安定供給  
- デバッグとトラブルシューティング  

---

## 応用プロジェクト例
- **ロボットアーム制御**: 多軸サーボの協調制御、逆運動学計算  
- **カメラジンバル**: センサーフィードバック制御、自動追尾  
- **自動ドア制御**: センサー連動開閉、安全機能追加  

---

## トラブルシューティング
### サーボが動かない場合
- 電源電圧（5V）の確認  
- GND接続の確認  
- PWM信号の出力確認  

### 振動や異音が発生する場合
- PWM周波数を50Hzに設定  
- 電源容量の確認  
- 配線の接触不良確認  

### 角度がずれる場合
- パルス幅（1–2ms）の調整  
- デューティ比計算の確認  
- サーボホーンの取り付け確認  

---

## デバッグとテスト
### デバッグ方法
- シリアル通信でのデバッグ出力  
- オシロスコープでPWM波形確認  
- LEDによる動作状態表示  

### テスト手順
- 電源投入時の初期化確認  
- 各角度での動作テスト  
- 連続動作での安定性確認  
- 複数サーボの同期動作テスト  

---

## 開発環境
### 必要なソフトウェア
- `STM32CubeIDE (最新版推奨)`  
- `STM32CubeMX (統合済み)`  
- `Git (バージョン管理用)`  

### ハードウェア要件
- `STM32L476RG Nucleoボード`  
- `USB Type-A to Mini-B ケーブル`  
- `ブレッドボード & ジャンパーワイヤー`  
- `5V電源アダプター（推奨）`  

---

## ファイル構成
STM32_Motor-Control/
├── Core/
│ ├── Inc/
│ │ ├── main.h
│ │ ├── tim.h
│ │ └── gpio.h
│ └── Src/
│ ├── main.c
│ ├── tim.c
│ └── gpio.c
├── Drivers/
│ ├── STM32L4xx_HAL_Driver/
│ └── CMSIS/
├── images/
│ ├── stm32l476rg_pinout.png
│ ├── wiring_diagram.jpg
│ └── servo_operation.jpg
├── motor_control.ioc
├── README.md
└── LICENSE


---

## 更新履歴
### v1.0.0 (2024-XX-XX)
- 初回リリース  
- SG90サーボモーター制御機能  
- 基本的な配線図とドキュメント  

---

## 今後の予定
- 複数サーボの同期制御改良  
- センサーフィードバック機能追加  
- GUI制御アプリケーション開発  
